<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium QR Code Generator</title>
<style>
/* ========== CSS RESET & BASE ========== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #0a0e27;
  --bg-secondary: #101540;
  --bg-card: rgba(16, 21, 64, 0.6);
  --glass-border: rgba(255, 255, 255, 0.08);
  --glass-bg: rgba(255, 255, 255, 0.04);
  --accent: #4f7df9;
  --accent-glow: rgba(79, 125, 249, 0.4);
  --accent-hover: #6b93ff;
  --success: #22c55e;
  --error: #ef4444;
  --warning: #f59e0b;
  --text-primary: #e8ecf4;
  --text-secondary: #8892b0;
  --text-muted: #5a6380;
  --radius: 16px;
  --radius-sm: 10px;
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --purple: #7c3aed;
  --cyan: #06b6d4;
  --emerald: #10b981;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1338 40%, #111a4a 100%);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.6;
}

/* ========== SCROLLBAR ========== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }

/* ========== ANIMATIONS ========== */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px var(--accent-glow); }
  50% { box-shadow: 0 0 40px var(--accent-glow), 0 0 60px rgba(79,125,249,0.2); }
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes scaleIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}
@keyframes borderGlow {
  0%, 100% { border-color: rgba(79,125,249,0.3); }
  50% { border-color: rgba(79,125,249,0.7); }
}

.fade-in-up { animation: fadeInUp 0.6s ease forwards; }
.fade-in { animation: fadeIn 0.5s ease forwards; }
.scale-in { animation: scaleIn 0.4s ease forwards; }

/* ========== BACKGROUND DECORATIONS ========== */
.bg-orb {
  position: fixed; border-radius: 50%;
  filter: blur(80px); opacity: 0.15;
  pointer-events: none; z-index: 0;
}
.bg-orb-1 { width: 500px; height: 500px; background: #4f7df9; top: -100px; right: -100px; }
.bg-orb-2 { width: 400px; height: 400px; background: #7c3aed; bottom: -50px; left: -100px; }
.bg-orb-3 { width: 300px; height: 300px; background: #06b6d4; top: 50%; left: 50%; transform: translate(-50%, -50%); }

/* ========== LAYOUT ========== */
.app-container {
  max-width: 1100px; margin: 0 auto;
  padding: 20px; position: relative; z-index: 1;
}

/* ========== GLASS CARD ========== */
.glass-card {
  background: var(--bg-card);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 28px;
  transition: var(--transition);
}
.glass-card:hover {
  border-color: rgba(255,255,255,0.12);
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}

/* ========== HEADER / PROFILE ========== */
.header {
  display: flex; align-items: center;
  justify-content: space-between; flex-wrap: wrap;
  gap: 16px; margin-bottom: 32px;
  animation: fadeInUp 0.5s ease;
}
.header-left { display: flex; align-items: center; gap: 16px; }
.header-logo {
  font-size: 26px; font-weight: 800;
  background: linear-gradient(135deg, #4f7df9, #7c3aed, #06b6d4);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text; letter-spacing: -0.5px;
}
.header-logo span {
  font-size: 14px; font-weight: 400; display: block;
  -webkit-text-fill-color: var(--text-secondary); letter-spacing: 1px;
}
.profile-area {
  display: flex; align-items: center; gap: 12px;
  cursor: pointer; padding: 8px 16px;
  border-radius: 50px; background: var(--glass-bg);
  border: 1px solid var(--glass-border); transition: var(--transition);
}
.profile-area:hover { background: rgba(255,255,255,0.08); border-color: var(--accent); }
.profile-avatar {
  width: 40px; height: 40px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #7c3aed);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700; color: #fff;
  overflow: hidden; flex-shrink: 0;
}
.profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
.profile-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
.profile-name small { display: block; font-weight: 400; font-size: 11px; color: var(--text-secondary); }

/* ========== MODALS ========== */
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
  z-index: 1000; display: none;
  align-items: center; justify-content: center; padding: 20px;
}
.modal-overlay.active { display: flex; }
.modal {
  background: linear-gradient(145deg, #131850, #0e1240);
  border: 1px solid var(--glass-border); border-radius: var(--radius);
  padding: 32px; width: 100%; max-width: 440px;
  animation: scaleIn 0.3s ease;
}
.modal h2 {
  font-size: 22px; margin-bottom: 24px;
  background: linear-gradient(135deg, #4f7df9, #7c3aed);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.modal-avatar-upload {
  width: 100px; height: 100px; border-radius: 50%;
  background: var(--glass-bg); border: 2px dashed var(--glass-border);
  margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;
  cursor: pointer; overflow: hidden; transition: var(--transition); position: relative;
}
.modal-avatar-upload:hover { border-color: var(--accent); }
.modal-avatar-upload img { width: 100%; height: 100%; object-fit: cover; }
.modal-avatar-upload .upload-icon { font-size: 28px; color: var(--text-muted); }
.modal-avatar-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

/* ========== FORM ELEMENTS ========== */
.form-group { margin-bottom: 20px; }
.form-label {
  display: block; font-size: 13px; font-weight: 600;
  color: var(--text-secondary); margin-bottom: 8px;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.form-input, .form-select, .form-textarea {
  width: 100%; padding: 14px 18px;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-sm);
  color: var(--text-primary); font-size: 15px;
  font-family: inherit; transition: var(--transition); outline: none;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(79,125,249,0.15);
  background: rgba(255,255,255,0.07);
}
.form-input::placeholder, .form-textarea::placeholder { color: var(--text-muted); }
.form-textarea { resize: vertical; min-height: 100px; }
.form-select option { background: var(--bg-secondary); color: var(--text-primary); }
.form-row {
  display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
}

/* ========== BUTTONS ========== */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  padding: 14px 28px; border: none; border-radius: var(--radius-sm);
  font-size: 15px; font-weight: 600; cursor: pointer;
  transition: var(--transition); font-family: inherit;
  text-decoration: none; position: relative; overflow: hidden;
}
.btn:active { transform: scale(0.97); }
.btn-primary {
  background: linear-gradient(135deg, #4f7df9, #6366f1);
  color: #fff; box-shadow: 0 4px 20px var(--accent-glow);
}
.btn-primary:hover {
  background: linear-gradient(135deg, #6b93ff, #818cf8);
  box-shadow: 0 6px 30px var(--accent-glow); transform: translateY(-2px);
}
.btn-success {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: #fff; box-shadow: 0 4px 20px rgba(34,197,94,0.3);
}
.btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(34,197,94,0.4); }
.btn-outline {
  background: transparent; border: 1px solid var(--glass-border);
  color: var(--text-secondary);
}
.btn-outline:hover { border-color: var(--accent); color: var(--accent); background: rgba(79,125,249,0.05); }
.btn-danger {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: #fff; box-shadow: 0 4px 20px rgba(239,68,68,0.3);
}
.btn-danger:hover { transform: translateY(-2px); }
.btn-sm { padding: 10px 18px; font-size: 13px; }
.btn-xs { padding: 7px 14px; font-size: 12px; border-radius: 8px; }
.btn-group { display: flex; gap: 12px; flex-wrap: wrap; }

/* ========== MODE TABS (Text vs Image) ========== */
.tabs {
  display: flex; gap: 4px;
  background: rgba(255,255,255,0.03);
  border-radius: var(--radius-sm); padding: 4px; margin-bottom: 24px;
}
.tab-btn {
  flex: 1; padding: 12px 20px; background: transparent;
  border: none; border-radius: 8px;
  color: var(--text-secondary); font-size: 14px; font-weight: 600;
  cursor: pointer; transition: var(--transition); font-family: inherit;
}
.tab-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }
.tab-btn.active {
  background: linear-gradient(135deg, #4f7df9, #6366f1);
  color: #fff; box-shadow: 0 4px 15px var(--accent-glow);
}

/* ========== QR TYPE SELECTOR CARDS ========== */
.qr-type-section { margin-bottom: 24px; }
.qr-type-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
}
.qr-type-card {
  position: relative; padding: 18px 14px; border-radius: var(--radius-sm);
  background: var(--glass-bg); border: 2px solid var(--glass-border);
  cursor: pointer; transition: all 0.35s ease; text-align: center;
  overflow: hidden;
}
.qr-type-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, transparent, transparent);
  transition: var(--transition);
}
.qr-type-card:hover {
  border-color: rgba(255,255,255,0.15);
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
}
.qr-type-card.active-type {
  border-color: var(--accent);
  background: rgba(79,125,249,0.08);
  box-shadow: 0 0 20px rgba(79,125,249,0.15);
  animation: borderGlow 2s ease infinite;
}
.qr-type-card.active-type.type-text { border-color: var(--accent); }
.qr-type-card.active-type.type-text::before { background: linear-gradient(90deg, var(--accent), #818cf8); }
.qr-type-card.active-type.type-url { border-color: var(--cyan); }
.qr-type-card.active-type.type-url::before { background: linear-gradient(90deg, var(--cyan), #22d3ee); }
.qr-type-card.active-type.type-vcard { border-color: var(--emerald); }
.qr-type-card.active-type.type-vcard::before { background: linear-gradient(90deg, var(--emerald), #34d399); }

.qr-type-icon {
  width: 56px; height: 56px; border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; margin: 0 auto 10px;
  transition: var(--transition);
}
.type-text .qr-type-icon { background: rgba(79,125,249,0.12); }
.type-url .qr-type-icon { background: rgba(6,182,212,0.12); }
.type-vcard .qr-type-icon { background: rgba(16,185,129,0.12); }
.qr-type-card.active-type .qr-type-icon { transform: scale(1.1); }

.qr-type-name {
  font-size: 14px; font-weight: 700; margin-bottom: 4px;
  color: var(--text-primary);
}
.qr-type-desc {
  font-size: 11px; color: var(--text-muted); line-height: 1.4;
}
.qr-type-check {
  position: absolute; top: 10px; right: 10px;
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--accent); color: #fff;
  display: none; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700;
}
.qr-type-card.active-type .qr-type-check { display: flex; }
.qr-type-card.active-type.type-url .qr-type-check { background: var(--cyan); }
.qr-type-card.active-type.type-vcard .qr-type-check { background: var(--emerald); }

/* ========== QR TYPE PREVIEW MODAL ========== */
.type-preview-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
  z-index: 1100; display: none;
  align-items: center; justify-content: center; padding: 20px;
}
.type-preview-overlay.active { display: flex; }
.type-preview-modal {
  background: linear-gradient(145deg, #131850, #0e1240);
  border: 1px solid var(--glass-border); border-radius: var(--radius);
  padding: 0; width: 100%; max-width: 520px;
  animation: scaleIn 0.3s ease; overflow: hidden;
}
.type-preview-header {
  padding: 28px 28px 0; display: flex;
  align-items: flex-start; justify-content: space-between;
}
.type-preview-close {
  width: 36px; height: 36px; border-radius: 50%;
  background: rgba(255,255,255,0.06); border: 1px solid var(--glass-border);
  color: var(--text-secondary); font-size: 18px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: var(--transition); flex-shrink: 0;
}
.type-preview-close:hover { background: rgba(239,68,68,0.15); color: #f87171; border-color: rgba(239,68,68,0.3); }
.type-preview-body { padding: 24px 28px 28px; }
.type-preview-icon-wrap {
  width: 72px; height: 72px; border-radius: 18px;
  display: flex; align-items: center; justify-content: center;
  font-size: 34px; margin-bottom: 16px;
}
.type-preview-title {
  font-size: 24px; font-weight: 800; margin-bottom: 6px;
}
.type-preview-subtitle {
  font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;
}
.type-preview-features {
  list-style: none; margin-bottom: 24px;
}
.type-preview-features li {
  padding: 10px 14px; font-size: 14px;
  color: var(--text-secondary); display: flex; align-items: center; gap: 12px;
  border-radius: 8px; margin-bottom: 4px;
  background: rgba(255,255,255,0.02);
  transition: var(--transition);
}
.type-preview-features li:hover { background: rgba(255,255,255,0.05); }
.type-preview-features li .feat-icon {
  width: 32px; height: 32px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center; font-size: 16px;
  flex-shrink: 0;
}
.type-preview-example {
  padding: 16px; border-radius: var(--radius-sm);
  background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.05);
  margin-bottom: 24px;
}
.type-preview-example-label {
  font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
  color: var(--text-muted); margin-bottom: 8px; font-weight: 700;
}
.type-preview-example-content {
  font-size: 13px; color: var(--text-secondary); line-height: 1.6;
  font-family: 'Courier New', monospace; word-break: break-all;
}
.type-preview-qr-sample {
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 24px;
}
.type-preview-qr-sample img {
  background: #fff; padding: 10px; border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  max-width: 150px;
}
.type-preview-actions { display: flex; gap: 12px; }
.type-preview-actions .btn { flex: 1; }

/* ========== QR TYPE INPUT FORMS ========== */
.type-form-area {
  animation: fadeInUp 0.4s ease;
}
.type-form-area[style*="display: none"] { animation: none; }

.vcard-form .form-row { margin-bottom: 0; }

/* ========== MAIN GRID ========== */
.main-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 24px; margin-bottom: 32px;
}

/* ========== FILE UPLOAD AREA ========== */
.file-upload-area {
  border: 2px dashed var(--glass-border);
  border-radius: var(--radius-sm); padding: 40px 20px;
  text-align: center; cursor: pointer;
  transition: var(--transition); position: relative;
}
.file-upload-area:hover, .file-upload-area.drag-over {
  border-color: var(--accent); background: rgba(79,125,249,0.05);
}
.file-upload-area input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
.file-upload-icon { font-size: 40px; margin-bottom: 12px; }
.file-upload-text { font-size: 15px; color: var(--text-secondary); }
.file-upload-text strong { color: var(--accent); }
.file-upload-hint { font-size: 12px; color: var(--text-muted); margin-top: 8px; }

/* ========== IMAGE PREVIEW ========== */
.image-preview {
  display: none; margin-top: 16px;
  border-radius: var(--radius-sm); overflow: hidden;
  border: 1px solid var(--glass-border); position: relative;
}
.image-preview img {
  width: 100%; max-height: 200px; object-fit: contain;
  background: rgba(0,0,0,0.2);
}
.image-preview .remove-btn {
  position: absolute; top: 8px; right: 8px;
  width: 28px; height: 28px; background: rgba(239,68,68,0.9);
  border: none; border-radius: 50%; color: #fff; font-size: 16px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}
.image-preview .remove-btn:hover { transform: scale(1.1); }

/* ========== QR RESULT ========== */
.qr-result-section {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; min-height: 300px;
}
.qr-placeholder { text-align: center; color: var(--text-muted); }
.qr-placeholder-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
.qr-placeholder p { font-size: 15px; }
.qr-image-container {
  display: none; flex-direction: column;
  align-items: center; gap: 20px; animation: scaleIn 0.5s ease;
}
.qr-image-wrapper {
  background: #fff; padding: 16px;
  border-radius: var(--radius-sm);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
.qr-image-wrapper img { display: block; max-width: 250px; width: 100%; height: auto; }

/* ========== LOADING SPINNER ========== */
.loading-overlay {
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 16px; padding: 40px;
}
.spinner {
  width: 48px; height: 48px;
  border: 3px solid rgba(79,125,249,0.2);
  border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.8s linear infinite;
}
.loading-text {
  color: var(--text-secondary); font-size: 14px;
  animation: pulse-glow 2s infinite; background: transparent; border: none;
}

/* ========== TOAST NOTIFICATIONS ========== */
.toast-container {
  position: fixed; top: 20px; right: 20px;
  z-index: 2000; display: flex; flex-direction: column; gap: 10px;
}
.toast {
  padding: 14px 20px; border-radius: var(--radius-sm);
  font-size: 14px; font-weight: 500;
  display: flex; align-items: center; gap: 10px;
  animation: slideDown 0.4s ease;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  min-width: 280px; backdrop-filter: blur(10px);
}
.toast-success { background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3); color: #4ade80; }
.toast-error { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #f87171; }
.toast-info { background: rgba(79,125,249,0.15); border: 1px solid rgba(79,125,249,0.3); color: #93b4ff; }

/* ========== SIZE SELECTOR ========== */
.size-selector {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 8px; margin-bottom: 20px;
}
.size-option {
  padding: 10px 8px; text-align: center;
  border: 1px solid var(--glass-border); border-radius: 8px;
  cursor: pointer; transition: var(--transition);
  font-size: 12px; font-weight: 600;
  color: var(--text-secondary); background: var(--glass-bg);
}
.size-option:hover { border-color: var(--accent); color: var(--accent); }
.size-option.active {
  border-color: var(--accent); background: rgba(79,125,249,0.12);
  color: var(--accent); box-shadow: 0 0 12px rgba(79,125,249,0.15);
}
.size-option .size-label { display: block; margin-bottom: 2px; }
.size-option .size-value { font-size: 10px; color: var(--text-muted); font-weight: 400; }

/* ========== HISTORY SECTION ========== */
.history-section { margin-top: 32px; }
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
}
.section-title {
  font-size: 22px; font-weight: 700;
  display: flex; align-items: center; gap: 10px;
}
.section-title .icon { font-size: 24px; }
.history-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 16px;
}
.history-card {
  padding: 18px; animation: fadeInUp 0.5s ease;
  display: flex; flex-direction: column; gap: 12px;
}
.history-card-header { display: flex; align-items: center; justify-content: space-between; }
.history-badge {
  padding: 4px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-text { background: rgba(79,125,249,0.15); color: var(--accent); }
.badge-url { background: rgba(6,182,212,0.15); color: var(--cyan); }
.badge-vcard { background: rgba(16,185,129,0.15); color: var(--emerald); }
.badge-image { background: rgba(124,58,237,0.15); color: #a78bfa; }
.history-date { font-size: 11px; color: var(--text-muted); }
.history-qr-preview {
  background: #fff; border-radius: 8px; padding: 10px; text-align: center;
}
.history-qr-preview img { max-width: 120px; height: auto; }
.history-content {
  font-size: 12px; color: var(--text-secondary);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  padding: 6px 10px; background: rgba(255,255,255,0.03); border-radius: 6px;
}
.history-actions { display: flex; gap: 8px; }
.history-actions .btn-xs { flex: 1; }
.empty-history { text-align: center; padding: 60px 20px; color: var(--text-muted); }
.empty-history-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }

/* ========== FOOTER ========== */
.footer {
  text-align: center; padding: 32px 20px;
  color: var(--text-muted); font-size: 13px;
  border-top: 1px solid var(--glass-border); margin-top: 48px;
}

/* ========== VIEW MODAL ========== */
.view-modal .qr-image-wrapper { margin: 0 auto; }

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .main-grid { grid-template-columns: 1fr; }
  .header { flex-direction: column; align-items: flex-start; }
  .size-selector { grid-template-columns: repeat(2, 1fr); }
  .history-grid { grid-template-columns: 1fr; }
  .app-container { padding: 12px; }
  .glass-card { padding: 20px; }
  .modal { padding: 24px; margin: 12px; }
  .btn-group { flex-direction: column; }
  .btn-group .btn { width: 100%; }
  .tabs { flex-direction: column; }
  .qr-type-grid { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
  .type-preview-modal { margin: 12px; }
  .type-preview-actions { flex-direction: column; }
}
@media (max-width: 480px) {
  .header-logo { font-size: 20px; }
  .qr-image-wrapper img { max-width: 180px; }
}
</style>
</head>
<body>

<!-- Background Decorations -->
<div class="bg-orb bg-orb-1"></div>
<div class="bg-orb bg-orb-2"></div>
<div class="bg-orb bg-orb-3"></div>

<!-- Toast Notification Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Profile Edit Modal -->
<div class="modal-overlay" id="profileModal">
  <div class="modal">
    <h2>‚ú® Edit Profile</h2>
    <div class="modal-avatar-upload" id="modalAvatarUpload">
      <span class="upload-icon" id="modalAvatarIcon">üì∑</span>
      <img id="modalAvatarPreview" style="display:none;" alt="Avatar">
      <input type="file" accept="image/*" id="modalAvatarInput">
    </div>
    <div class="form-group">
      <label class="form-label">Your Name</label>
      <input type="text" class="form-input" id="profileNameInput" placeholder="Enter your name" maxlength="30">
    </div>
    <div class="btn-group" style="justify-content:flex-end;">
      <button class="btn btn-outline btn-sm" onclick="closeProfileModal()">Cancel</button>
      <button class="btn btn-primary btn-sm" onclick="saveProfile()">Save Profile</button>
    </div>
  </div>
</div>

<!-- View QR Modal -->
<div class="modal-overlay" id="viewModal">
  <div class="modal view-modal" style="max-width:500px; text-align:center;">
    <h2>üîç QR Code Preview</h2>
    <div class="qr-image-wrapper" style="display:inline-block; margin-bottom:20px;">
      <img id="viewModalQR" src="" alt="QR Code" style="max-width:300px; width:100%;">
    </div>
    <p id="viewModalInfo" style="color:var(--text-secondary); font-size:13px; margin-bottom:20px; word-break:break-all;"></p>
    <div class="btn-group" style="justify-content:center;">
      <button class="btn btn-success btn-sm" onclick="downloadViewModalQR('png')">‚¨á PNG</button>
      <button class="btn btn-primary btn-sm" onclick="downloadViewModalQR('jpg')">‚¨á JPG</button>
      <button class="btn btn-outline btn-sm" onclick="closeViewModal()">Close</button>
    </div>
  </div>
</div>

<!-- ========== QR TYPE PREVIEW MODAL ========== -->
<div class="type-preview-overlay" id="typePreviewOverlay">
  <div class="type-preview-modal" id="typePreviewModal">
    <div class="type-preview-header">
      <div></div>
      <button class="type-preview-close" onclick="closeTypePreview()">‚úï</button>
    </div>
    <div class="type-preview-body">
      <div class="type-preview-icon-wrap" id="tpIcon"></div>
      <div class="type-preview-title" id="tpTitle"></div>
      <div class="type-preview-subtitle" id="tpSubtitle"></div>

      <ul class="type-preview-features" id="tpFeatures"></ul>

      <div class="type-preview-example" id="tpExample">
        <div class="type-preview-example-label">Example Data Encoded</div>
        <div class="type-preview-example-content" id="tpExampleContent"></div>
      </div>

      <div class="type-preview-qr-sample">
        <img id="tpSampleQR" src="" alt="Sample QR">
      </div>

      <div class="type-preview-actions">
        <button class="btn btn-outline btn-sm" onclick="closeTypePreview()">Close</button>
        <button class="btn btn-primary btn-sm" id="tpSelectBtn" onclick="selectTypeFromPreview()">Select This Type</button>
      </div>
    </div>
  </div>
</div>

<!-- ========== APP CONTAINER ========== -->
<div class="app-container">

  <!-- Header / Profile Section -->
  <header class="header glass-card" style="padding:16px 24px;">
    <div class="header-left">
      <div>
        <div class="header-logo">
          QR Studio
          <span>Premium QR Code Generator</span>
        </div>
      </div>
    </div>
    <div class="profile-area" onclick="openProfileModal()" title="Edit Profile">
      <div class="profile-avatar" id="headerAvatar">
        <span id="headerAvatarLetter">U</span>
        <img id="headerAvatarImg" style="display:none;" alt="Avatar">
      </div>
      <div class="profile-name">
        <span id="headerName">User</span>
        <small>Click to edit</small>
      </div>
    </div>
  </header>

  <!-- Main Content Grid -->
  <div class="main-grid">
    <!-- Left: Input Section -->
    <div class="glass-card fade-in-up" style="animation-delay:0.1s;">
      <h3 style="font-size:18px; margin-bottom:16px; display:flex; align-items:center; gap:8px;">
        ‚ö° Generate QR Code
      </h3>

      <!-- Mode Tabs (Text vs Image) -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="text" onclick="switchTab('text')">üìù Text / Data</button>
        <button class="tab-btn" data-tab="image" onclick="switchTab('image')">üñºÔ∏è Photo / File</button>
      </div>

      <!-- ====== TEXT TAB ====== -->
      <div id="textTab">

        <!-- QR Type Selector Cards -->
        <div class="qr-type-section">
          <label class="form-label">Choose QR Code Type</label>
          <div class="qr-type-grid">
            <!-- Plain Text Card -->
            <div class="qr-type-card type-text active-type" data-qr-type="text" onclick="selectQRType('text')">
              <div class="qr-type-check">‚úì</div>
              <div class="qr-type-icon">üìù</div>
              <div class="qr-type-name">Plain Text</div>
              <div class="qr-type-desc">Messages, notes, any text content</div>
              <button class="btn btn-outline btn-xs" style="margin-top:10px; width:100%; font-size:11px; padding:5px 8px;" onclick="event.stopPropagation(); previewQRType('text')">üëÅ Preview</button>
            </div>
            <!-- URL/Link Card -->
            <div class="qr-type-card type-url" data-qr-type="url" onclick="selectQRType('url')">
              <div class="qr-type-check">‚úì</div>
              <div class="qr-type-icon">üîó</div>
              <div class="qr-type-name">URL / Link</div>
              <div class="qr-type-desc">Websites, social media, web pages</div>
              <button class="btn btn-outline btn-xs" style="margin-top:10px; width:100%; font-size:11px; padding:5px 8px;" onclick="event.stopPropagation(); previewQRType('url')">üëÅ Preview</button>
            </div>
            <!-- vCard/Contact Card -->
            <div class="qr-type-card type-vcard" data-qr-type="vcard" onclick="selectQRType('vcard')">
              <div class="qr-type-check">‚úì</div>
              <div class="qr-type-icon">üë§</div>
              <div class="qr-type-name">Contact Card</div>
              <div class="qr-type-desc">vCard with name, phone, email & more</div>
              <button class="btn btn-outline btn-xs" style="margin-top:10px; width:100%; font-size:11px; padding:5px 8px;" onclick="event.stopPropagation(); previewQRType('vcard')">üëÅ Preview</button>
            </div>
          </div>
        </div>

        <!-- Dynamic Input Forms for each QR type -->

        <!-- Plain Text Form -->
        <div class="type-form-area" id="formText">
          <div class="form-group">
            <label class="form-label">Enter Text Content</label>
            <textarea class="form-textarea" id="textInput" placeholder="Enter your text, message, or any content here..." rows="4"></textarea>
          </div>
          <button class="btn btn-outline btn-xs" onclick="clearInput('textInput')" style="margin-bottom:16px;">‚úï Clear</button>
        </div>

        <!-- URL Form -->
        <div class="type-form-area" id="formUrl" style="display:none;">
          <div class="form-group">
            <label class="form-label">Enter Website URL</label>
            <input type="url" class="form-input" id="urlInput" placeholder="https://www.example.com">
          </div>
          <div class="form-group" style="margin-bottom:4px;">
            <label class="form-label" style="margin-bottom:6px;">Quick Links</label>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn btn-outline btn-xs" onclick="prefillUrl('https://')">https://</button>
              <button class="btn btn-outline btn-xs" onclick="prefillUrl('https://www.')">https://www.</button>
              <button class="btn btn-outline btn-xs" onclick="prefillUrl('mailto:')">mailto:</button>
              <button class="btn btn-outline btn-xs" onclick="prefillUrl('tel:')">tel:</button>
            </div>
          </div>
          <button class="btn btn-outline btn-xs" onclick="clearInput('urlInput')" style="margin-top:12px; margin-bottom:16px;">‚úï Clear</button>
        </div>

        <!-- vCard Form -->
        <div class="type-form-area vcard-form" id="formVcard" style="display:none;">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">First Name *</label>
              <input type="text" class="form-input" id="vcFirstName" placeholder="John">
            </div>
            <div class="form-group">
              <label class="form-label">Last Name *</label>
              <input type="text" class="form-input" id="vcLastName" placeholder="Doe">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Organization</label>
            <input type="text" class="form-input" id="vcOrg" placeholder="Company Inc.">
          </div>
          <div class="form-group">
            <label class="form-label">Job Title</label>
            <input type="text" class="form-input" id="vcTitle" placeholder="Software Engineer">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-input" id="vcPhone" placeholder="+1 234 567 890">
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="vcEmail" placeholder="john@example.com">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Website</label>
            <input type="url" class="form-input" id="vcWebsite" placeholder="https://example.com">
          </div>
          <div class="form-group">
            <label class="form-label">Address</label>
            <input type="text" class="form-input" id="vcAddress" placeholder="123 Main St, City, Country">
          </div>
          <button class="btn btn-outline btn-xs" onclick="clearVcardForm()" style="margin-bottom:16px;">‚úï Clear All</button>
        </div>

      </div>

      <!-- ====== IMAGE TAB ====== -->
      <div id="imageTab" style="display:none;">
        <div class="form-group">
          <div class="file-upload-area" id="fileUploadArea">
            <div class="file-upload-icon">üìÅ</div>
            <div class="file-upload-text">Drag & drop or <strong>browse</strong></div>
            <div class="file-upload-hint">JPG or PNG only ‚Ä¢ Max 5 MB ‚Ä¢ Auto-compressed for QR</div>
            <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,image/jpeg,image/png">
          </div>
          <div class="image-preview" id="imagePreview">
            <img id="imagePreviewImg" alt="Preview">
            <button class="remove-btn" onclick="removeImage()">‚úï</button>
          </div>
          <div id="imageCompressNote" style="display:none; margin-top:12px; padding:12px 16px; border-radius:10px; background:rgba(124,58,237,0.08); border:1px solid rgba(124,58,237,0.2); font-size:12px; color:#c4b5fd; line-height:1.5;">
            üí° <strong>Note:</strong> Image will be auto-compressed to a tiny thumbnail to fit QR code data limits (~2.9 KB max). The QR code will contain the image as a data URL.
          </div>
        </div>
      </div>

      <!-- Size Selector -->
      <div class="form-group">
        <label class="form-label">QR Code Size</label>
        <div class="size-selector">
          <div class="size-option" data-size="200" onclick="selectSize(this)">
            <span class="size-label">Small</span>
            <span class="size-value">200√ó200</span>
          </div>
          <div class="size-option active" data-size="300" onclick="selectSize(this)">
            <span class="size-label">Medium</span>
            <span class="size-value">300√ó300</span>
          </div>
          <div class="size-option" data-size="500" onclick="selectSize(this)">
            <span class="size-label">Big</span>
            <span class="size-value">500√ó500</span>
          </div>
          <div class="size-option" data-size="1000" onclick="selectSize(this)">
            <span class="size-label">HQ</span>
            <span class="size-value">1000√ó1000</span>
          </div>
        </div>
      </div>

      <!-- Generate Button -->
      <button class="btn btn-primary" style="width:100%;" onclick="generateQR()" id="generateBtn">
        üöÄ Generate QR Code
      </button>
    </div>

    <!-- Right: QR Result Section -->
    <div class="glass-card fade-in-up" style="animation-delay:0.2s;">
      <h3 style="font-size:18px; margin-bottom:16px; display:flex; align-items:center; gap:8px;">
        üì± Your QR Code
      </h3>

      <div class="qr-result-section">
        <!-- Placeholder -->
        <div class="qr-placeholder" id="qrPlaceholder">
          <div class="qr-placeholder-icon">üì±</div>
          <p>Your QR code will appear here</p>
          <p style="font-size:12px; margin-top:4px; color:var(--text-muted);">Select a type and click Generate</p>
        </div>

        <!-- Loading -->
        <div class="loading-overlay" id="loadingOverlay">
          <div class="spinner"></div>
          <span class="loading-text">Generating QR Code...</span>
        </div>

        <!-- QR Image Result -->
        <div class="qr-image-container" id="qrResult">
          <div class="qr-image-wrapper">
            <img id="qrImage" src="" alt="Generated QR Code">
          </div>
          <div id="qrTypeBadgeResult" style="margin-bottom:4px;"></div>
          <div class="btn-group">
            <button class="btn btn-success btn-sm" onclick="downloadQR('png')">‚¨á PNG</button>
            <button class="btn btn-primary btn-sm" onclick="downloadQR('jpg')">‚¨á JPG</button>
          </div>
          <p style="font-size:12px; color:var(--text-muted);" id="qrSizeInfo"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- History Section -->
  <div class="history-section fade-in-up" style="animation-delay:0.3s;">
    <div class="glass-card">
      <div class="section-header">
        <div class="section-title">
          <span class="icon">üìã</span> Generation History
        </div>
        <div class="btn-group">
          <button class="btn btn-outline btn-xs" onclick="clearHistory()">üóë Clear All</button>
        </div>
      </div>

      <div class="history-grid" id="historyGrid">
        <div class="empty-history" id="emptyHistory">
          <div class="empty-history-icon">üì≠</div>
          <p>No QR codes generated yet</p>
          <p style="font-size:12px; margin-top:4px;">Your history will appear here</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>QR Studio ‚Äî Premium QR Code Generator</p>
    <p style="margin-top:4px; font-size:11px;">Powered by GOQR API ‚Ä¢ All data stored locally</p>
  </footer>
</div>

<script>
/* =============================================
   PREMIUM QR CODE GENERATOR - JavaScript
   ============================================= */

// ========== STATE ==========
let currentTab = 'text';        // 'text' or 'image'
let selectedQRType = 'text';    // 'text', 'url', or 'vcard'
let selectedSize = 300;
let currentFileBase64 = null;
let currentQRUrl = null;
let profileData = { name: 'User', avatar: null };
let previewingType = null;      // which type is being previewed in modal

/* ========== QR TYPE DEFINITIONS ========== */
const QR_TYPES = {
  text: {
    id: 'text',
    name: 'Plain Text',
    icon: 'üìù',
    color: '#4f7df9',
    colorLight: 'rgba(79,125,249,0.12)',
    badgeClass: 'badge-text',
    subtitle: 'Encode any text, notes, or messages into a scannable QR code.',
    features: [
      { icon: '‚úèÔ∏è', bg: 'rgba(79,125,249,0.1)', text: 'Supports any text, numbers, or special characters' },
      { icon: 'üìè', bg: 'rgba(79,125,249,0.1)', text: 'Up to ~4,296 alphanumeric characters' },
      { icon: 'üìã', bg: 'rgba(79,125,249,0.1)', text: 'Great for notes, serial numbers, and IDs' },
      { icon: 'üåê', bg: 'rgba(79,125,249,0.1)', text: 'Unicode support for multiple languages' },
    ],
    example: 'Hello! This is a sample plain text message encoded into a QR code.',
    sampleData: 'Hello World - Plain Text QR',
  },
  url: {
    id: 'url',
    name: 'URL / Link',
    icon: 'üîó',
    color: '#06b6d4',
    colorLight: 'rgba(6,182,212,0.12)',
    badgeClass: 'badge-url',
    subtitle: 'Create QR codes that instantly open websites, social media, or any web page.',
    features: [
      { icon: 'üåç', bg: 'rgba(6,182,212,0.1)', text: 'Opens directly in browser when scanned' },
      { icon: 'üì±', bg: 'rgba(6,182,212,0.1)', text: 'Works with any URL ‚Äî websites, videos, files' },
      { icon: 'üìß', bg: 'rgba(6,182,212,0.1)', text: 'Supports mailto: and tel: links too' },
      { icon: 'üîí', bg: 'rgba(6,182,212,0.1)', text: 'HTTPS URLs for secure connections' },
    ],
    example: 'https://www.example.com',
    sampleData: 'https://www.example.com',
  },
  vcard: {
    id: 'vcard',
    name: 'Contact Card (vCard)',
    icon: 'üë§',
    color: '#10b981',
    colorLight: 'rgba(16,185,129,0.12)',
    badgeClass: 'badge-vcard',
    subtitle: 'Share contact information instantly. Scanning adds you to their phone contacts.',
    features: [
      { icon: 'üë§', bg: 'rgba(16,185,129,0.1)', text: 'Full name, title, and organization' },
      { icon: 'üìû', bg: 'rgba(16,185,129,0.1)', text: 'Phone number ‚Äî tap to call directly' },
      { icon: 'üìß', bg: 'rgba(16,185,129,0.1)', text: 'Email address for quick messaging' },
      { icon: 'üè†', bg: 'rgba(16,185,129,0.1)', text: 'Website and physical address included' },
    ],
    example: 'BEGIN:VCARD\nVERSION:3.0\nN:Doe;John\nFN:John Doe\nORG:Company Inc.\nTITLE:Engineer\nTEL:+1234567890\nEMAIL:john@example.com\nURL:https://example.com\nEND:VCARD',
    sampleData: 'BEGIN:VCARD\nVERSION:3.0\nFN:John Doe\nTEL:+1234567890\nEMAIL:john@example.com\nEND:VCARD',
  }
};

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', () => {
  loadProfile();
  loadHistory();
  setupFileInput();
});

// ========== TOAST NOTIFICATIONS ==========
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è' };
  toast.innerHTML = `<span>${icons[type] || '‚ÑπÔ∏è'}</span> <span>${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-10px)';
    toast.style.transition = '0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ========== TAB SWITCHING (Text vs Image) ==========
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });
  document.getElementById('textTab').style.display = tab === 'text' ? 'block' : 'none';
  document.getElementById('imageTab').style.display = tab === 'image' ? 'block' : 'none';
}

// ========== QR TYPE SELECTION ==========
function selectQRType(type) {
  selectedQRType = type;
  // Update type card visuals
  document.querySelectorAll('.qr-type-card').forEach(card => {
    card.classList.remove('active-type');
  });
  document.querySelector(`.qr-type-card[data-qr-type="${type}"]`).classList.add('active-type');

  // Show/hide corresponding form
  document.getElementById('formText').style.display = type === 'text' ? 'block' : 'none';
  document.getElementById('formUrl').style.display = type === 'url' ? 'block' : 'none';
  document.getElementById('formVcard').style.display = type === 'vcard' ? 'block' : 'none';

  // Re-trigger animation
  const formEl = document.getElementById('form' + type.charAt(0).toUpperCase() + type.slice(1));
  if (formEl) {
    formEl.style.animation = 'none';
    formEl.offsetHeight; // reflow
    formEl.style.animation = 'fadeInUp 0.4s ease';
  }
}

// ========== QR TYPE PREVIEW MODAL ==========
function previewQRType(type) {
  previewingType = type;
  const t = QR_TYPES[type];
  if (!t) return;

  // Fill modal content
  document.getElementById('tpIcon').innerHTML = t.icon;
  document.getElementById('tpIcon').style.background = t.colorLight;
  document.getElementById('tpTitle').textContent = t.name;
  document.getElementById('tpTitle').style.color = t.color;
  document.getElementById('tpSubtitle').textContent = t.subtitle;

  // Features
  const featList = document.getElementById('tpFeatures');
  featList.innerHTML = '';
  t.features.forEach(f => {
    const li = document.createElement('li');
    li.innerHTML = `<span class="feat-icon" style="background:${f.bg};">${f.icon}</span> ${f.text}`;
    featList.appendChild(li);
  });

  // Example
  document.getElementById('tpExampleContent').textContent = t.example;

  // Sample QR
  const sampleUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(t.sampleData)}`;
  document.getElementById('tpSampleQR').src = sampleUrl;

  // Select button color
  const selectBtn = document.getElementById('tpSelectBtn');
  selectBtn.style.background = `linear-gradient(135deg, ${t.color}, ${t.color}dd)`;
  selectBtn.textContent = selectedQRType === type ? '‚úì Already Selected' : `Select ${t.name}`;
  selectBtn.disabled = false;

  // Show modal
  document.getElementById('typePreviewOverlay').classList.add('active');
}

function closeTypePreview() {
  document.getElementById('typePreviewOverlay').classList.remove('active');
  previewingType = null;
}

function selectTypeFromPreview() {
  if (previewingType) {
    selectQRType(previewingType);
    showToast(`${QR_TYPES[previewingType].name} type selected!`, 'success');
    closeTypePreview();
  }
}

// ========== SIZE SELECTION ==========
function selectSize(el) {
  document.querySelectorAll('.size-option').forEach(o => o.classList.remove('active'));
  el.classList.add('active');
  selectedSize = parseInt(el.dataset.size);
}

// ========== FILE INPUT SETUP ==========
function setupFileInput() {
  const fileInput = document.getElementById('fileInput');
  const uploadArea = document.getElementById('fileUploadArea');
  fileInput.addEventListener('change', handleFileSelect);
  uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
  uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('drag-over'); });
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault(); uploadArea.classList.remove('drag-over');
    if (e.dataTransfer.files.length > 0) { fileInput.files = e.dataTransfer.files; handleFileSelect({ target: fileInput }); }
  });
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
  if (!validTypes.includes(file.type)) { showToast('Invalid format! Only JPG and PNG allowed.', 'error'); e.target.value = ''; return; }
  if (file.size > 5 * 1024 * 1024) { showToast('File too large! Max 5 MB.', 'error'); e.target.value = ''; return; }
  const reader = new FileReader();
  reader.onload = (event) => {
    currentFileBase64 = event.target.result;
    document.getElementById('imagePreviewImg').src = currentFileBase64;
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('fileUploadArea').style.display = 'none';
    document.getElementById('imageCompressNote').style.display = 'block';
    showToast('Image loaded! It will be auto-compressed when generating QR.', 'success');
  };
  reader.readAsDataURL(file);
}

function removeImage() {
  currentFileBase64 = null;
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('fileUploadArea').style.display = 'block';
  document.getElementById('fileInput').value = '';
  document.getElementById('imageCompressNote').style.display = 'none';
}

function clearInput(id) {
  document.getElementById(id).value = '';
  showToast('Input cleared', 'info');
}

function prefillUrl(prefix) {
  const inp = document.getElementById('urlInput');
  if (!inp.value) inp.value = prefix;
  else if (!inp.value.startsWith(prefix)) inp.value = prefix + inp.value;
  inp.focus();
}

function clearVcardForm() {
  ['vcFirstName','vcLastName','vcOrg','vcTitle','vcPhone','vcEmail','vcWebsite','vcAddress'].forEach(id => {
    document.getElementById(id).value = '';
  });
  showToast('Contact form cleared', 'info');
}

// ========== BUILD DATA STRING FOR QR ==========
function buildQRData() {
  if (currentTab === 'image') {
    if (!currentFileBase64) { showToast('Please upload an image first!', 'error'); return null; }
    return { data: currentFileBase64, type: 'image', displayContent: 'üñºÔ∏è Image Data' };
  }

  if (selectedQRType === 'text') {
    const text = document.getElementById('textInput').value.trim();
    if (!text) { showToast('Please enter some text!', 'error'); return null; }
    return { data: text, type: 'text', displayContent: text };
  }

  if (selectedQRType === 'url') {
    let url = document.getElementById('urlInput').value.trim();
    if (!url) { showToast('Please enter a URL!', 'error'); return null; }
    // Auto-add https:// if no protocol
    if (!/^[a-zA-Z]+:/.test(url)) url = 'https://' + url;
    return { data: url, type: 'url', displayContent: url };
  }

  if (selectedQRType === 'vcard') {
    const fn = document.getElementById('vcFirstName').value.trim();
    const ln = document.getElementById('vcLastName').value.trim();
    if (!fn && !ln) { showToast('Please enter at least a name for the contact card!', 'error'); return null; }
    const org = document.getElementById('vcOrg').value.trim();
    const title = document.getElementById('vcTitle').value.trim();
    const phone = document.getElementById('vcPhone').value.trim();
    const email = document.getElementById('vcEmail').value.trim();
    const website = document.getElementById('vcWebsite').value.trim();
    const address = document.getElementById('vcAddress').value.trim();

    // Build vCard 3.0 string
    let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
    vcard += `N:${ln};${fn};;;\n`;
    vcard += `FN:${fn}${ln ? ' ' + ln : ''}\n`;
    if (org) vcard += `ORG:${org}\n`;
    if (title) vcard += `TITLE:${title}\n`;
    if (phone) vcard += `TEL;TYPE=CELL:${phone}\n`;
    if (email) vcard += `EMAIL:${email}\n`;
    if (website) vcard += `URL:${website}\n`;
    if (address) vcard += `ADR;TYPE=HOME:;;${address};;;;\n`;
    vcard += 'END:VCARD';

    const displayName = `${fn}${ln ? ' ' + ln : ''}`;
    return { data: vcard, type: 'vcard', displayContent: `vCard: ${displayName}` };
  }

  return null;
}

// ========== IMAGE COMPRESSION FOR QR ENCODING ==========
/* QR codes can hold ~2,953 bytes max (Version 40, L error correction).
   Images as Base64 are far too large, so we must aggressively compress
   them using Canvas ‚Äî shrinking dimensions and JPEG quality until the
   resulting data URL fits inside a QR code. */
async function compressImageForQR(base64Data) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Progressive compression: try larger sizes first, shrink until it fits
      const attempts = [
        { maxDim: 120, quality: 0.5 },
        { maxDim: 100, quality: 0.45 },
        { maxDim: 90,  quality: 0.4 },
        { maxDim: 80,  quality: 0.35 },
        { maxDim: 70,  quality: 0.3 },
        { maxDim: 60,  quality: 0.25 },
        { maxDim: 50,  quality: 0.2 },
        { maxDim: 45,  quality: 0.18 },
        { maxDim: 40,  quality: 0.15 },
        { maxDim: 35,  quality: 0.12 },
        { maxDim: 30,  quality: 0.1 },
        { maxDim: 25,  quality: 0.08 },
        { maxDim: 20,  quality: 0.06 },
        { maxDim: 15,  quality: 0.05 },
      ];

      for (const attempt of attempts) {
        let w, h;
        if (img.width >= img.height) {
          w = Math.min(attempt.maxDim, img.width);
          h = Math.max(1, Math.round(img.height * (w / img.width)));
        } else {
          h = Math.min(attempt.maxDim, img.height);
          w = Math.max(1, Math.round(img.width * (h / img.height)));
        }

        canvas.width = w;
        canvas.height = h;
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, w, h);
        ctx.drawImage(img, 0, 0, w, h);

        const compressed = canvas.toDataURL('image/jpeg', attempt.quality);

        // Target: keep total data URL under 2500 chars so it fits
        // in a QR code after encoding (max ~2953 bytes binary mode)
        if (compressed.length <= 2500) {
          resolve({ data: compressed, dimensions: `${w}√ó${h}`, size: compressed.length });
          return;
        }
      }

      // Absolute last resort ‚Äî 10px wide
      const lastW = 10;
      const lastH = Math.max(1, Math.round(img.height * (10 / img.width)));
      canvas.width = lastW;
      canvas.height = lastH;
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, lastW, lastH);
      ctx.drawImage(img, 0, 0, lastW, lastH);
      const lastTry = canvas.toDataURL('image/jpeg', 0.04);
      resolve({ data: lastTry, dimensions: `${lastW}√ó${lastH}`, size: lastTry.length });
    };
    img.onerror = () => reject(new Error('Failed to process image'));
    img.src = base64Data;
  });
}

// ========== QR CODE GENERATION ==========
async function generateQR() {
  const qrData = buildQRData();
  if (!qrData) return;

  // Show loading
  document.getElementById('qrPlaceholder').style.display = 'none';
  document.getElementById('qrResult').style.display = 'none';
  document.getElementById('loadingOverlay').style.display = 'flex';

  /* --- If the input is an image, compress it first --- */
  if (qrData.type === 'image') {
    try {
      document.querySelector('.loading-text').textContent = 'Compressing image for QR encoding...';
      const compressed = await compressImageForQR(qrData.data);
      qrData.data = compressed.data;
      qrData.displayContent = `üñºÔ∏è Image (${compressed.dimensions}, ${(compressed.size / 1024).toFixed(1)}KB)`;
      showToast(`Image auto-compressed to ${compressed.dimensions} to fit QR limits`, 'info');
    } catch (err) {
      document.getElementById('loadingOverlay').style.display = 'none';
      document.getElementById('qrPlaceholder').style.display = 'block';
      showToast('Failed to process image. Please try a different image.', 'error');
      return;
    }
  }

  // Reset loading text
  document.querySelector('.loading-text').textContent = 'Generating QR Code...';

  // Warn about large non-image data
  if (qrData.type !== 'image' && qrData.data.length > 2953) {
    showToast('Data is very large. QR may be hard to scan.', 'info');
  }

  const encodedData = encodeURIComponent(qrData.data);
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${selectedSize}x${selectedSize}&data=${encodedData}`;

  try {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = qrUrl;
      setTimeout(() => reject(new Error('Timeout')), 20000);
    });

    currentQRUrl = qrUrl;
    document.getElementById('qrImage').src = qrUrl;
    document.getElementById('qrImage').crossOrigin = 'anonymous';
    document.getElementById('qrSizeInfo').textContent = `Size: ${selectedSize}√ó${selectedSize}px`;

    // Show type badge in result
    const typeInfo = QR_TYPES[qrData.type] || QR_TYPES.text;
    const badgeClass = qrData.type === 'image' ? 'badge-image' : typeInfo.badgeClass;
    const badgeLabel = qrData.type === 'image' ? 'üñºÔ∏è Image' : `${typeInfo.icon} ${typeInfo.name}`;
    document.getElementById('qrTypeBadgeResult').innerHTML =
      `<span class="history-badge ${badgeClass}">${badgeLabel}</span>`;

    // Hide loading, show result
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('qrResult').style.display = 'flex';

    showToast('QR Code generated successfully!', 'success');

    // Save to history
    saveToHistory({
      type: qrData.type,
      content: qrData.displayContent.length > 80
        ? qrData.displayContent.substring(0, 80) + '...'
        : qrData.displayContent,
      fullContent: qrData.type === 'image'
        ? qrData.data.substring(0, 200) + '...'
        : qrData.data,
      size: selectedSize,
      qrUrl: qrUrl,
      date: new Date().toLocaleString()
    });

  } catch (error) {
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('qrPlaceholder').style.display = 'block';
    showToast('Failed to generate QR code. Please try again or use smaller data.', 'error');
  }
}

// ========== DOWNLOAD FUNCTIONS ==========
function downloadQR(format) {
  if (!currentQRUrl) return;
  downloadImage(currentQRUrl, format, `qr-code-${Date.now()}`);
}

function downloadImage(url, format, filename) {
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = () => {
    const canvas = document.createElement('canvas');
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    const ctx = canvas.getContext('2d');
    if (format === 'jpg') { ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
    ctx.drawImage(img, 0, 0);
    const mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
    const dataUrl = canvas.toDataURL(mimeType, 0.95);
    const link = document.createElement('a');
    link.download = `${filename}.${format}`;
    link.href = dataUrl;
    link.click();
    showToast(`Downloaded as ${format.toUpperCase()}!`, 'success');
  };
  img.onerror = () => { window.open(url, '_blank'); showToast('Download started in new tab', 'info'); };
  img.src = url;
}

// ========== HISTORY SYSTEM ==========
function getHistory() {
  try { return JSON.parse(localStorage.getItem('qr_history') || '[]'); }
  catch { return []; }
}

function saveToHistory(item) {
  const history = getHistory();
  history.unshift(item);
  if (history.length > 50) history.pop();
  try { localStorage.setItem('qr_history', JSON.stringify(history)); }
  catch (e) {
    while (history.length > 5) {
      history.pop();
      try { localStorage.setItem('qr_history', JSON.stringify(history)); break; }
      catch (e2) { /* continue removing */ }
    }
  }
  loadHistory();
}

function loadHistory() {
  const history = getHistory();
  const grid = document.getElementById('historyGrid');
  const empty = document.getElementById('emptyHistory');

  if (history.length === 0) {
    grid.innerHTML = '';
    grid.appendChild(empty);
    empty.style.display = 'block';
    return;
  }

  grid.innerHTML = '';
  history.forEach((item, index) => {
    const card = document.createElement('div');
    card.className = 'glass-card history-card';
    card.style.animationDelay = `${index * 0.05}s`;

    const typeInfo = QR_TYPES[item.type] || QR_TYPES.text;
    let badgeClass, badgeLabel;
    if (item.type === 'image') {
      badgeClass = 'badge-image';
      badgeLabel = 'üñºÔ∏è Image';
    } else {
      badgeClass = typeInfo.badgeClass;
      badgeLabel = `${typeInfo.icon} ${typeInfo.name}`;
    }

    const displayContent = item.content && item.content.length > 40
      ? item.content.substring(0, 40) + '...'
      : (item.content || 'QR Code');

    card.innerHTML = `
      <div class="history-card-header">
        <span class="history-badge ${badgeClass}">${badgeLabel}</span>
        <span class="history-date">${item.date}</span>
      </div>
      <div class="history-qr-preview">
        <img src="${item.qrUrl}" alt="QR Code" loading="lazy" style="max-width:120px;">
      </div>
      <div class="history-content" title="${(item.content || '').replace(/"/g, '&quot;')}">
        ${displayContent} ‚Ä¢ ${item.size}√ó${item.size}px
      </div>
      <div class="history-actions">
        <button class="btn btn-outline btn-xs" onclick="viewHistoryItem(${index})">üëÅ View</button>
        <button class="btn btn-primary btn-xs" onclick="downloadHistoryItem(${index})">‚¨á Save</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

function viewHistoryItem(index) {
  const history = getHistory();
  const item = history[index];
  if (!item) return;
  document.getElementById('viewModalQR').src = item.qrUrl;
  const typeInfo = QR_TYPES[item.type] || QR_TYPES.text;
  const typeLabel = item.type === 'image' ? 'Image QR Code' : typeInfo.name;
  const info = `<strong>${typeLabel}</strong><br>"${item.content || ''}"<br>Size: ${item.size}√ó${item.size}px ‚Ä¢ ${item.date}`;
  document.getElementById('viewModalInfo').innerHTML = info;
  document.getElementById('viewModal').classList.add('active');
  document.getElementById('viewModal').dataset.qrUrl = item.qrUrl;
}

function downloadViewModalQR(format) {
  const url = document.getElementById('viewModal').dataset.qrUrl;
  if (url) downloadImage(url, format, `qr-history-${Date.now()}`);
}
function closeViewModal() { document.getElementById('viewModal').classList.remove('active'); }

function downloadHistoryItem(index) {
  const history = getHistory();
  const item = history[index];
  if (!item) return;
  downloadImage(item.qrUrl, 'png', `qr-history-${Date.now()}`);
}

function clearHistory() {
  if (getHistory().length === 0) { showToast('History is already empty', 'info'); return; }
  localStorage.removeItem('qr_history');
  loadHistory();
  showToast('History cleared!', 'success');
}

// ========== PROFILE SYSTEM ==========
function loadProfile() {
  try {
    const saved = JSON.parse(localStorage.getItem('qr_profile'));
    if (saved) { profileData = saved; updateProfileUI(); }
  } catch { /* use defaults */ }
}

function updateProfileUI() {
  const letterEl = document.getElementById('headerAvatarLetter');
  const imgEl = document.getElementById('headerAvatarImg');
  const nameEl = document.getElementById('headerName');
  nameEl.textContent = profileData.name || 'User';
  if (profileData.avatar) {
    imgEl.src = profileData.avatar; imgEl.style.display = 'block'; letterEl.style.display = 'none';
  } else {
    imgEl.style.display = 'none'; letterEl.style.display = 'block';
    letterEl.textContent = (profileData.name || 'U').charAt(0).toUpperCase();
  }
}

function openProfileModal() {
  document.getElementById('profileNameInput').value = profileData.name || '';
  const modalPreview = document.getElementById('modalAvatarPreview');
  const modalIcon = document.getElementById('modalAvatarIcon');
  if (profileData.avatar) {
    modalPreview.src = profileData.avatar; modalPreview.style.display = 'block'; modalIcon.style.display = 'none';
  } else {
    modalPreview.style.display = 'none'; modalIcon.style.display = 'block';
  }
  document.getElementById('profileModal').classList.add('active');
}

function closeProfileModal() { document.getElementById('profileModal').classList.remove('active'); }

function saveProfile() {
  const name = document.getElementById('profileNameInput').value.trim();
  if (name) profileData.name = name;
  const modalPreview = document.getElementById('modalAvatarPreview');
  if (modalPreview.src && modalPreview.style.display !== 'none') profileData.avatar = modalPreview.src;
  try { localStorage.setItem('qr_profile', JSON.stringify(profileData)); } catch { /* storage full */ }
  updateProfileUI();
  closeProfileModal();
  showToast('Profile saved!', 'success');
}

// Profile avatar upload in modal
document.getElementById('modalAvatarInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (!file.type.startsWith('image/')) { showToast('Please select an image file', 'error'); return; }
  const reader = new FileReader();
  reader.onload = (event) => {
    const modalPreview = document.getElementById('modalAvatarPreview');
    const modalIcon = document.getElementById('modalAvatarIcon');
    modalPreview.src = event.target.result;
    modalPreview.style.display = 'block';
    modalIcon.style.display = 'none';
  };
  reader.readAsDataURL(file);
});

// ========== MODAL CLOSE HANDLERS ==========
document.getElementById('profileModal').addEventListener('click', function(e) { if (e.target === this) closeProfileModal(); });
document.getElementById('viewModal').addEventListener('click', function(e) { if (e.target === this) closeViewModal(); });
document.getElementById('typePreviewOverlay').addEventListener('click', function(e) { if (e.target === this) closeTypePreview(); });

// Keyboard close
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') { closeProfileModal(); closeViewModal(); closeTypePreview(); }
});
</script>
</body>
</html>
